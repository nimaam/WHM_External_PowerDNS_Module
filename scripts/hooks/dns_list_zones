#!/usr/bin/env python3
"""Hook script for listing DNS zones - returns zones from PowerDNS API."""

import json
import os
import sys
from pathlib import Path

# Always log hook execution for debugging
try:
    with open("/var/log/ultahost_dns/hook_debug.log", "a") as f:
        f.write(f"dns_list_zones hook called at {os.popen('date').read().strip()}\n")
        f.write(f"Python path: {sys.path}\n")
        f.write(f"Arguments: {sys.argv}\n")
        f.write(f"Environment: {dict(os.environ)}\n")
except:
    pass

# Add src to path
possible_paths = [
    Path(__file__).parent.parent.parent / "src",
    Path("/usr/local/cpanel/bin/ultahost_dns"),
]

for path in possible_paths:
    if path.exists():
        sys.path.insert(0, str(path))
        break

try:
    from ultahost_dns.config import Config
    from ultahost_dns.logger import PluginLogger
    from ultahost_dns.powerdns_client import PowerDNSClient
except ImportError as e:
    with open("/var/log/ultahost_dns/ultahost_dns.log", "a") as f:
        f.write(f"ERROR: Failed to import modules: {e}\n")
    # Exit with non-zero to let default DNS handle it
    sys.exit(1)


def main():
    """Handle DNS zone listing."""
    logger = PluginLogger.get_logger()
    
    # Always log that hook was called
    logger.info("DNS listzones hook called - attempting to override API2 response")

    # Debug: Log config status
    try:
        config = Config.load()
        logger.info(f"Config loaded: enabled={config.get('enabled')} (type: {type(config.get('enabled'))}), api_url={bool(config.get('api_url'))}, api_key={bool(config.get('api_key'))}")
    except Exception as e:
        logger.error(f"Error loading config: {e}", exc_info=True)
        sys.exit(1)  # Exit with error to let default handle it

    is_enabled = Config.is_enabled()
    logger.info(f"Plugin enabled check result: {is_enabled}")

    if not is_enabled:
        logger.warning("Ultahost DNS plugin is disabled, skipping hook")
        # Exit with non-zero to let default DNS handle it
        sys.exit(1)

    try:
        client = PowerDNSClient()
        zones = client.list_zones()

        # For API2 PRE hooks, we need to output the response in a way cPanel can use
        # Try multiple output methods
        
        # Method 1: Output to stdout (standard)
        result = {
            "status": 1,
            "statusmsg": "OK",
            "data": {
                "zone": []  # Note: cPanel expects "zone" not "zones"
            }
        }

        for zone in zones:
            zone_name = zone.get("name", "").rstrip(".")
            if zone_name:
                result["data"]["zone"].append({
                    "domain": zone_name,
                    "zone": zone_name,
                    "zonefile": f"{zone_name}.db",  # cPanel expects zonefile
                })

        # Output JSON to stdout
        output = json.dumps(result)
        print(output, file=sys.stdout)
        sys.stdout.flush()
        
        # Also write to a file that cPanel might read
        try:
            with open("/tmp/ultahost_dns_listzones_response.json", "w") as f:
                f.write(output)
        except:
            pass

        logger.info(f"Listed {len(zones)} zones from PowerDNS API, output: {output[:200]}")
        
        # For PRE hooks, exit with 0 means "I handled it, use my output"
        # But cPanel might not use it. Try exiting with 0 anyway.
        sys.exit(0)

    except Exception as e:
        logger.error(f"Exception listing zones: {e}", exc_info=True)
        # Exit with error to let default DNS handle it
        sys.exit(1)


if __name__ == "__main__":
    main()
