#!/usr/bin/env python3
"""Hook script for listing DNS zones - returns zones from PowerDNS API."""

import json
import os
import sys
from pathlib import Path

# Add src to path
possible_paths = [
    Path(__file__).parent.parent.parent / "src",
    Path("/usr/local/cpanel/bin/ultahost_dns"),
]

for path in possible_paths:
    if path.exists():
        sys.path.insert(0, str(path))
        break

try:
    from ultahost_dns.config import Config
    from ultahost_dns.logger import PluginLogger
    from ultahost_dns.powerdns_client import PowerDNSClient
except ImportError as e:
    with open("/var/log/ultahost_dns/ultahost_dns.log", "a") as f:
        f.write(f"ERROR: Failed to import modules: {e}\n")
    sys.exit(0)


def main():
    """Handle DNS zone listing."""
    logger = PluginLogger.get_logger()

    if not Config.is_enabled():
        logger.debug("Ultahost DNS plugin is disabled, skipping hook")
        sys.exit(0)

    try:
        client = PowerDNSClient()
        zones = client.list_zones()

        # For API2 hooks, we need to output JSON that cPanel can parse
        # cPanel API2 expects a specific format
        result = {
            "status": 1,
            "statusmsg": "OK",
            "data": {
                "zones": []
            }
        }

        for zone in zones:
            zone_name = zone.get("name", "").rstrip(".")
            if zone_name:
                result["data"]["zones"].append({
                    "domain": zone_name,
                    "zone": zone_name,
                })

        # Output JSON for API2
        print(json.dumps(result))
        logger.info(f"Listed {len(zones)} zones from PowerDNS API")
        
        # Exit with 0 to indicate we handled it
        sys.exit(0)

    except Exception as e:
        logger.error(f"Exception listing zones: {e}", exc_info=True)
        # Output error in API2 format
        error_result = {
            "status": 0,
            "statusmsg": f"Error: {str(e)}",
            "data": {}
        }
        print(json.dumps(error_result))
        sys.exit(1)


if __name__ == "__main__":
    main()
