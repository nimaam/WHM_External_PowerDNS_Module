#!/usr/bin/env python3
"""Hook script for deleting DNS records."""

import sys
from pathlib import Path

# Add src to path
sys.path.insert(0, str(Path(__file__).parent.parent.parent / "src"))

from ultahost_dns.config import Config
from ultahost_dns.logger import PluginLogger
from ultahost_dns.permissions import Permissions
from ultahost_dns.powerdns_client import PowerDNSClient


def main():
    """Handle DNS record deletion."""
    logger = PluginLogger.get_logger()

    if not Config.is_enabled():
        logger.debug("Ultahost DNS plugin is disabled, skipping hook")
        sys.exit(0)

    # Parse arguments from cPanel
    # Format: zone_name name type
    if len(sys.argv) < 4:
        logger.error("Invalid arguments for dns_delete_record hook")
        sys.exit(1)

    zone_name = sys.argv[1]
    name = sys.argv[2]
    record_type = sys.argv[3]
    username = sys.argv[4] if len(sys.argv) > 4 else "root"

    logger.info(f"Deleting DNS record: {name} {record_type} from {zone_name} (user: {username})")

    # Check permissions
    if not Permissions.can_manage_zone(username, zone_name):
        logger.error(f"User {username} does not have permission to modify zone {zone_name}")
        sys.exit(1)

    # Delete record from PowerDNS ONLY (not from local DNS)
    # Since we're using PRE hook, we handle it completely
    try:
        client = PowerDNSClient()
        if client.delete_record(zone_name, name, record_type):
            logger.info(f"Successfully deleted record {name} {record_type} via PowerDNS API")
            # Exit with success - this prevents default DNS from deleting
            sys.exit(0)
        else:
            logger.error(f"Failed to delete record {name} {record_type} via PowerDNS API")
            # Exit with error to let default DNS handle it (fallback)
            sys.exit(1)
    except Exception as e:
        logger.error(f"Exception deleting record: {e}", exc_info=True)
        sys.exit(1)


if __name__ == "__main__":
    main()


